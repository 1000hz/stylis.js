<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>stylis byte</title>
	<script src='../../../stylis.js'></script>
	<script src='../index.js'></script>
</head>
<body>

<script>
var sample = `
body {
	color:red;
}
body {
	color:red;
	background: red;
}
`
stylis.use(stylisByte)

var program = stylis('', sample)
var {heap, byte, length} = program

function toString (heap, byte, length) {
	var RULE_START = 0
	var RULE_END = 1
	var SELECTOR = 3
	var PROPERTY = 10
	var VALUE = 11

	var index = 0
	var code = 0
	var output = ''
	var token = ''

	while (index < length) {
		code = byte[index]

		switch (code) {
			case RULE_START: {
				index++
				continue
			}
			case RULE_END: {
				index++
				output += '}'
				continue
			}
			case SELECTOR: {
				token = '{'
				break
			}
			case PROPERTY: {
				token = ':'
				break
			}
			case VALUE: {
				token = ';'
				break
			}
		}

		output += heap[byte[++index]] + token
		index++
	}

	return output
}

console.log(program)
console.log(toString(heap, byte, length))


function bench (fn, report, name) {
	var start = performance.now()

	for (var i = 0; i < 1e5; i++) {
		var result = fn()
	}

	var end = performance.now()

	if (report) {
		console.log(end-start, 'ms', result)
	} else {
		console.log('warming up '+name)
	}

	return result
}

// warm up
bench(function () {
	return toString(heap, byte, length)
}, false, 'byte code')

// run
bench(function () {
	return toString(heap, byte, length)
}, true, 'byte code')

stylis.use(null)

// warm up
bench(function () {
	return stylis('', sample)
}, false, 'stylis')

// run
bench(function () {
	return stylis('', sample)
}, true, 'stylis')


/**
 *
 * body {color:red}body{color:red;}
 * should produce
 *
 * byte = [
 * 		0,  // rule start
 * 		3,  // selector
 * 		2,  // selector address, heap[2] === 'body'
 * 		10, // property
 * 		0,  // property address, heap[0] === 'color'
 * 		11, // value
 * 		1,  // value address, heap[1] === 'red'
 * 		1,  // rule end
 *
 * 		0,  // rule start 
 * 		3,  // selector
 * 		2,  // selector address, heap[2] === 'body'
 * 		10, // property
 * 		0,  // property address heap[0] === 'color'
 * 		11, // value
 * 		1,  // value address, heap[1] === 'red'
 * 		1   // rule end
 * ]
 *
 * heap = {
 * 		'color',
 * 		'red',
 * 		'body'
 * }
 */
</script>

</body>
</html>
